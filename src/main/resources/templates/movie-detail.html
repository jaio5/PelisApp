<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${movie.title + ' - PelisApp'}">Película - PelisApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        :root {
            --primary-color: #1e1e1e;
            --secondary-color: #2c2c2c;
            --accent-color: #ff6b35;
            --text-color: #ffffff;
            --muted-color: #b3b3b3;
        }

        body {
            background-color: var(--primary-color);
            color: var(--text-color);
        }

        .movie-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .movie-poster {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .movie-info h1 {
            color: var(--accent-color);
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .genre-badge {
            background: linear-gradient(135deg, var(--accent-color), #e55a30);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        .rating-section {
            background: var(--secondary-color);
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .average-rating {
            text-align: center;
            margin-bottom: 2rem;
        }

        .rating-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .rating-stars {
            font-size: 1.5rem;
            color: #ffc107;
            margin: 0.5rem 0;
        }

        .star-distribution {
            margin: 1rem 0;
        }

        .star-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .star-label {
            min-width: 80px;
            font-size: 0.9rem;
        }

        .progress {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            margin: 0 1rem;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent-color), #ffc107);
        }

        .review-form {
            background: var(--secondary-color);
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .star-rating {
            display: flex;
            gap: 0.25rem;
            margin: 1rem 0;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            cursor: pointer;
            font-size: 2rem;
            color: #666;
            transition: color 0.2s;
        }

        .star-rating label:hover,
        .star-rating input:checked ~ label,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }

        .review-card {
            background: var(--secondary-color);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .review-card:hover {
            border-color: rgba(255, 107, 53, 0.5);
            transform: translateY(-2px);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .review-author {
            font-weight: bold;
            color: var(--accent-color);
        }

        .review-rating {
            color: #ffc107;
        }

        .review-text {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .review-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .like-button {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .like-button:hover {
            background: var(--accent-color);
            color: white;
        }

        .review-date {
            color: var(--muted-color);
            font-size: 0.875rem;
        }

        .back-link {
            color: var(--accent-color);
            text-decoration: none;
            margin-bottom: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-link:hover {
            color: #e55a30;
        }

        /* Estilos para el reparto compacto (desktop) */
        .cast-compact-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .cast-compact-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .cast-compact-item:hover {
            background: rgba(255, 107, 53, 0.1);
        }

        .cast-compact-image {
            flex-shrink: 0;
        }

        .cast-compact-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted-color);
        }

        .cast-no-photo {
            background: rgba(255, 255, 255, 0.1);
            color: var(--muted-color);
        }

        .cast-compact-info {
            flex: 1;
            min-width: 0;
        }

        .cast-compact-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cast-compact-role {
            font-size: 0.8rem;
            color: var(--muted-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Responsive: En móvil (< lg) mostrar el diseño original de tarjetas */
        @media (max-width: 992px) {
            .cast-compact-list {
                display: none;
            }

            /* Mostrar las tarjetas de reparto originales en móvil */
        }

        @media (min-width: 992px) {
            /* En desktop, ocultar las tarjetas móviles */
        }

        @media (max-width: 768px) {
            .movie-info h1 {
                font-size: 2rem;
            }

            .rating-number {
                font-size: 2rem;
            }

            .star-rating label {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--secondary-color); border-bottom: 2px solid var(--accent-color);">
        <div class="container">
            <a class="navbar-brand" href="/" style="color: var(--accent-color); font-weight: bold; font-size: 1.8rem;">
                <i class="fas fa-film me-2"></i>PelisApp
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/}">
                    <i class="fas fa-home me-1"></i>Inicio
                </a>
                <a class="nav-link" th:href="@{/login}" sec:authorize="!isAuthenticated()">
                    <i class="fas fa-sign-in-alt me-1"></i>Login
                </a>
                <a class="nav-link" th:href="@{/perfil}" sec:authorize="isAuthenticated()">
                    <i class="fas fa-user me-1"></i>Mi Perfil
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Link para volver -->
        <a href="javascript:history.back()" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Volver al catálogo
        </a>

        <!-- Mostrar mensajes -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${success}">Mensaje de éxito</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${error}">Mensaje de error</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Cabecera de la película -->
        <div class="movie-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    <img th:if="${movie.posterLocalPath != null && !movie.posterLocalPath.isEmpty()}"
                         th:src="${movie.posterLocalPath}"
                         th:alt="${movie.title}"
                         class="movie-poster shadow-lg rounded">
                    <img th:unless="${movie.posterLocalPath != null && !movie.posterLocalPath.isEmpty()}"
                         th:if="${movie.posterPath != null && !movie.posterPath.isEmpty()}"
                         th:src="${movie.posterPath.startsWith('http') ? movie.posterPath : 'https://image.tmdb.org/t/p/w500' + movie.posterPath}"
                         th:alt="${movie.title}"
                         class="movie-poster shadow-lg rounded">
                    <div th:if="${(movie.posterLocalPath == null || movie.posterLocalPath.isEmpty()) && (movie.posterPath == null || movie.posterPath.isEmpty())}"
                         class="movie-poster d-flex align-items-center justify-content-center bg-dark text-muted rounded shadow-lg"
                         style="height: 400px; width: 300px;">
                        <i class="fas fa-film fa-3x"></i>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="movie-info p-4 rounded bg-dark bg-opacity-75 shadow-sm">
                        <h1 class="mb-2" style="color: var(--accent-color); font-size: 2.2rem;">
                            <i class="fas fa-film me-2"></i><span th:text="${movie.title}">Título de la Película</span>
                        </h1>
                        <div class="d-flex gap-3 mb-3">
                            <span class="badge bg-secondary"><i class="fas fa-calendar-alt me-1"></i><span th:text="${#temporals.year(movie.releaseDate)}">2023</span></span>
                            <span class="badge bg-secondary"><i class="fas fa-clock me-1"></i><span th:text="${movie.runtimeMinutes + ' min'}">120 min</span></span>
                        </div>
                        <div class="mb-3">
                            <span th:each="category : ${movie.categories}" class="genre-badge">
                                <span th:text="${category.name}">Género</span>
                            </span>
                        </div>
                        <div class="movie-description bg-secondary bg-opacity-25 p-3 rounded mb-2">
                            <h4 class="mb-1">Sinopsis</h4>
                            <p th:text="${movie.description ?: 'No hay descripción disponible.'}" class="lead mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valoraciones y reseñas -->
        <div class="row">
            <div class="col-lg-3 mb-4 d-flex align-items-start justify-content-center">
                <div class="rating-section p-3 rounded shadow-sm bg-dark bg-opacity-75 w-100" style="max-width: 260px;">
                    <h3 class="text-center mb-3" style="font-size:1.2rem;"><i class="fas fa-star me-2"></i>Media</h3>
                    <div class="average-rating mb-2" th:if="${movieStats.totalReviews > 0}">
                        <div class="rating-number mb-1" th:text="${movieStats.averageRatingFormatted}" style="font-size:2.2rem;">4.5</div>
                        <div class="rating-stars mb-1">
                            <span th:each="i : ${#numbers.sequence(1, 5)}"
                                  th:class="${i <= movieStats.averageRating ? 'fas fa-star' : (i - 0.5 <= movieStats.averageRating ? 'fas fa-star-half-alt' : 'far fa-star')}"></span>
                        </div>
                        <div class="text-muted mb-1" style="font-size:0.95rem;">
                            <span th:text="${movieStats.totalReviews}">150</span> valoraciones
                        </div>
                    </div>
                    <div class="average-rating mb-2" th:unless="${movieStats.totalReviews > 0}">
                        <div class="rating-number" style="font-size:2.2rem;">-</div>
                        <div class="text-muted" style="font-size:0.95rem;">Sin valoraciones aún</div>
                    </div>
                    <div class="star-distribution mb-1" th:if="${movieStats.totalReviews > 0}">
                        <h5 style="font-size:1rem;">Distribución</h5>
                        <div th:each="star : ${#numbers.sequence(5, 1, -1)}" class="star-bar">
                            <span class="star-label" style="min-width:40px;font-size:0.85rem;">
                                <span th:text="${star}">5</span>
                                <i class="fas fa-star text-warning"></i>
                            </span>
                            <div class="progress flex-grow-1" style="height:6px;margin:0 0.5rem;">
                                <div class="progress-bar bg-warning"
                                     th:style="'width: ' + ${movieStats.getStarPercentage(star)} + '%'">
                                </div>
                            </div>
                            <small class="text-muted ms-2" th:text="${movieStats.starDistribution[star - 1]}" style="font-size:0.85rem;">10</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="review-form mb-4 p-4 rounded shadow-sm bg-dark bg-opacity-75" th:if="${canReview}">
                    <h4><i class="fas fa-pen me-2"></i>Escribe tu Reseña</h4>
                    <form id="resenaForm">
                        <div class="mb-3">
                            <label class="form-label">Tu valoración:</label>
                            <div class="star-rating" id="starRating">
                                <input type="radio" name="stars" value="1" id="star1" required>
                                <label for="star1" class="fas fa-star"></label>
                                <input type="radio" name="stars" value="2" id="star2">
                                <label for="star2" class="fas fa-star"></label>
                                <input type="radio" name="stars" value="3" id="star3">
                                <label for="star3" class="fas fa-star"></label>
                                <input type="radio" name="stars" value="4" id="star4">
                                <label for="star4" class="fas fa-star"></label>
                                <input type="radio" name="stars" value="5" id="star5">
                                <label for="star5" class="fas fa-star"></label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewText" class="form-label">Tu comentario (opcional):</label>
                            <textarea class="form-control" id="reviewText" name="text" rows="3"
                                      placeholder="Comparte tu opinión sobre esta película... (opcional)"
                                      maxlength="1000"></textarea>
                            <div class="form-text">Opcional. Máximo 1000 caracteres. Puedes valorar solo con estrellas.</div>
                        </div>
                        <input type="hidden" name="movieId" th:value="${movie.id}" />
                        <input type="hidden" name="userId" th:value="${currentUser.id}" />
                        <button type="submit" class="btn btn-sm btn-primary rounded-pill">
                            <i class="fas fa-paper-plane me-2"></i>
                            Publicar Valoración
                        </button>
                        <div id="resenaMessage" class="mt-2" style="display:none;"></div>
                    </form>
                </div>
                <div class="review-form" th:if="${userReview != null}">
                    <h4><i class="fas fa-check-circle me-2"></i>Tu Reseña</h4>
                    <div class="alert alert-info">
                        <strong>Ya has valorado esta película</strong><br>
                        Puntuación: <span th:each="i : ${#numbers.sequence(1, userReview.stars)}" class="text-warning">★</span><br>
                        <em th:if="${userReview.text != null and !userReview.text.trim().isEmpty()}"
                           th:text="${userReview.text}">Tu comentario...</em>
                        <em th:unless="${userReview.text != null and !userReview.text.trim().isEmpty()}"
                           class="text-muted">
                           <i class="fas fa-star me-1"></i>Valoración sin comentario
                        </em>
                    </div>
                </div>
                <div class="review-form" th:unless="${isAuthenticated}">
                    <h4><i class="fas fa-sign-in-alt me-2"></i>Valora esta Película</h4>
                    <div class="alert alert-warning">
                        <strong>Inicia sesión para poder valorar y comentar películas</strong><br>
                        <a th:href="@{/login}" class="btn btn-sm mt-2" style="background: var(--accent-color); color: white;">
                            Iniciar Sesión
                        </a>
                    </div>
                </div>
                <!-- Comentarios de usuarios debajo del formulario o de tu reseña -->
                <div class="mt-4">
                    <h4><i class="fas fa-comments me-2"></i>Reseñas de Usuarios
                        <span class="badge" style="background: var(--accent-color);" th:text="${movieStats.totalReviews}">0</span>
                    </h4>
                    <div th:if="${#lists.isEmpty(reviews)}" class="text-center py-4 text-muted">
                        <i class="fas fa-comment-slash fa-3x mb-3"></i>
                        <p>Aún no hay reseñas para esta película.<br>¡Sé el primero en valorarla!</p>
                    </div>
                    <div th:each="review : ${reviews}" class="review-card mb-3 p-3 rounded shadow-sm bg-dark bg-opacity-75">
                        <div class="review-header d-flex justify-content-between align-items-center mb-2">
                            <span class="review-author fw-bold text-accent" th:text="${review.user.username}">Usuario</span>
                            <span class="review-rating">
                                <span th:each="i : ${#numbers.sequence(1, review.stars)}" class="fas fa-star text-warning"></span>
                                <span th:each="i : ${#numbers.sequence(review.stars + 1, 5)}" class="far fa-star text-muted"></span>
                            </span>
                        </div>
                        <div class="review-text mb-2">
                            <span th:if="${review.text != null and !review.text.trim().isEmpty()}"
                                  th:text="${review.text}">Texto de la reseña aquí...</span>
                            <span th:unless="${review.text != null and !review.text.trim().isEmpty()}"
                                  class="text-muted fst-italic">
                                <i class="fas fa-star me-1"></i>Valoración sin comentario
                            </span>
                        </div>
                        <div class="review-actions d-flex align-items-center gap-2">
                            <button class="like-button"
                                    th:if="${isAuthenticated}"
                                    th:id="${'like-btn-' + review.id}"
                                    th:onclick="'likeReview(' + ${review.id} + ')'">
                                <i class="fas fa-thumbs-up me-1"></i>
                                <span th:text="${review.likesCount ?: 0}">0</span>
                            </button>
                            <button class="btn btn-danger btn-sm ms-2 rounded-pill"
                                    th:if="${#authorization.expression('hasAnyRole(''ROLE_ADMIN'', ''ADMIN'', ''Administrador'')')}"
                                    th:onclick="'deleteReview(' + ${review.id} + ', \' ' + ${review.user.username} + '\')'"
                                    title="Eliminar reseña">
                                <i class="fas fa-trash"></i>
                            </button>
                            <span class="review-date ms-auto text-muted" th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy HH:mm')}">
                                01/01/2023 12:00
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 order-3 order-lg-3 mb-4 d-block" style="border-left:2px solid #ff6b35; min-height:100px;">
                <!-- DEPURACIÓN: Este texto debe aparecer siempre -->
                <div style="background:#222;padding:1rem;border-radius:8px;margin-bottom:1rem;color:#fff;">
                    TEST COLUMNA DERECHA - SIEMPRE DEBE VERSE
                </div>
                <div class="cast-section">
                    <div class="mb-4">
                        <h5><i class="fas fa-video me-2"></i>Dirección</h5>
                        <div th:if="${movieDetails != null and movieDetails.directors != null and not #lists.isEmpty(movieDetails.directors)}" class="cast-compact-list">
                            <div th:each="director : ${movieDetails.directors}" class="cast-compact-item d-flex align-items-center gap-3 bg-dark bg-opacity-75 rounded shadow-sm mb-2 p-2">
                                <div class="cast-compact-image">
                                    <img th:if="${director.profileUrl != null}"
                                         th:src="${director.profileUrl}"
                                         th:alt="${director.name}"
                                         class="cast-compact-photo rounded-circle shadow">
                                    <div th:unless="${director.profileUrl != null}"
                                         class="cast-compact-photo cast-no-photo rounded-circle bg-secondary bg-opacity-25 d-flex align-items-center justify-content-center">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <div class="cast-compact-info">
                                    <div class="cast-compact-name fw-bold" th:text="${director.name}">Nombre Director</div>
                                    <div class="cast-compact-role text-muted" th:text="${director.job}">Director</div>
                                </div>
                            </div>
                        </div>
                        <div th:if="${movieDetails == null or movieDetails.directors == null or #lists.isEmpty(movieDetails.directors)}" class="alert alert-warning p-2 mt-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>No hay información de dirección disponible.
                        </div>
                    </div>
                    <div class="mb-4">
                        <h5><i class="fas fa-users me-2"></i>Reparto Principal</h5>
                        <div th:if="${movieDetails != null and movieDetails.castMembers != null and not #lists.isEmpty(movieDetails.castMembers)}" class="cast-compact-list">
                            <div th:each="actor, iterStat : ${movieDetails.castMembers}"
                                 th:if="${iterStat.index < 8}"
                                 class="cast-compact-item d-flex align-items-center gap-3 bg-dark bg-opacity-75 rounded shadow-sm mb-2 p-2">
                                <div class="cast-compact-image">
                                    <img th:if="${actor.profileUrl != null}"
                                         th:src="${actor.profileUrl}"
                                         th:alt="${actor.name}"
                                         class="cast-compact-photo rounded-circle shadow">
                                    <div th:unless="${actor.profileUrl != null}"
                                         class="cast-compact-photo cast-no-photo rounded-circle bg-secondary bg-opacity-25 d-flex align-items-center justify-content-center">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <div class="cast-compact-info">
                                    <div class="cast-compact-name fw-bold" th:text="${actor.name}">Nombre Actor</div>
                                    <div class="cast-compact-role text-muted" th:text="${actor.character}">Personaje</div>
                                </div>
                            </div>
                            <div th:if="${#lists.size(movieDetails.castMembers) > 8}" class="text-center mt-2">
                                <button class="btn btn-outline-light btn-sm rounded-pill" onclick="toggleFullCast()">
                                    <i class="fas fa-plus me-2"></i>Ver más reparto
                                </button>
                            </div>
                        </div>
                        <div th:if="${movieDetails == null or movieDetails.castMembers == null or #lists.isEmpty(movieDetails.castMembers)}" class="alert alert-warning p-2 mt-2">
                            <i class="fas fa-exclamation-triangle me-2"></i>No hay información de reparto disponible.
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- cierre de row principal -->
        <!-- ...resto del código... -->

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para dar like a reseñas
        window.likeReview = function(reviewId) {
            fetch(`/api/reviews/${reviewId}/like?userId=${document.querySelector('input[name="userId"]').value}`, {
                method: 'POST'
            }).then(res => {
                if (res.ok) {
                    location.reload();
                } else {
                    alert('Error al dar like');
                }
            });
        };
        // Función para eliminar reseñas (solo admins)
        window.deleteReview = function(reviewId, username) {
            if (confirm(`¿Estás seguro de que quieres eliminar la reseña de ${username}?\n\nEsta acción no se puede deshacer.`)) {
                fetch(`/admin/review/${reviewId}/delete`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.text())
                .then(data => {
                    if (data.includes('exitosamente')) {
                        location.reload();
                    } else {
                        alert('Error: ' + data);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error eliminando la reseña: ' + error.message);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('resenaForm');
            if (!form) return;
            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                const data = new FormData(form);
                const payload = Object.fromEntries(data.entries());
                try {
                    const res = await fetch('/api/reviews', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const msg = document.getElementById('resenaMessage');
                    if (res.ok) {
                        msg.style.display = 'block';
                        msg.textContent = 'Reseña enviada correctamente. Recargando...';
                        setTimeout(() => location.reload(), 1200);
                    } else if (res.status === 401) {
                        msg.style.display = 'block';
                        msg.textContent = 'Debes iniciar sesión para escribir una reseña.';
                    } else {
                        const text = await res.text();
                        msg.style.display = 'block';
                        msg.textContent = 'Error: ' + text;
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        });
    </script>
</body>
</html>
