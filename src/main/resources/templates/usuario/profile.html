<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Perfil</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <script th:src="@{/js/app.js}" defer></script>
</head>
<body>
<header>
    <nav>
        <a th:href="@{/}">Inicio</a> |
        <a th:href="@{/peliculas}">Películas</a>
    </nav>
</header>
<main>
    <section>
        <h1 th:text="${usuario.username}">Usuario</h1>
        <p th:if="${usuario.displayName != null}"><strong>Nombre:</strong> <span th:text="${usuario.displayName}"></span></p>
        <p><strong>Nivel crítico:</strong> <span th:text="${usuario.criticLevel}">0</span></p>

        <div>
            <h3>Roles</h3>
            <ul>
                <li th:each="r : ${usuario.roles}" th:text="${r.name}">ROLE_USER</li>
            </ul>
            <div th:if="${isAdmin}">
                <label for="roleSelect">Asignar role:</label>
                <select id="roleSelect">
                    <option th:each="role: ${allRoles}" th:value="${role.id}" th:text="${role.name}"></option>
                </select>
                <button th:onclick="|assignRole(${usuario.id})|">Asignar</button>
            </div>
        </div>

        <div>
            <h3>Etiquetas</h3>
            <ul>
                <li th:each="t : ${usuario.tags}">
                    <span th:text="${t.name}">Etiqueta</span>
                </li>
            </ul>
            <div th:if="${isAdmin}">
                <label for="tagSelect">Asignar etiqueta:</label>
                <select id="tagSelect">
                    <option th:each="tag: ${allTags}" th:value="${tag.id}" th:text="${tag.name}"></option>
                </select>
                <button th:onclick="|assignTag(${usuario.id})|">Asignar</button>
            </div>
        </div>
    </section>

    <section>
        <h2>Reseñas</h2>
        <ul>
            <li th:each="r : ${reviews}">
                <div><a th:href="@{/pelicula/{id}(id=${r.movie.id})}" th:text="${r.movie.title}">Pelicula</a></div>
                <div th:text="${r.stars}">5</div>
                <div th:text="${r.text}">Comentario</div>
            </li>
        </ul>
    </section>
</main>

<script>
    function assignRole(userId) {
        const sel = document.getElementById('roleSelect');
        const roleId = sel.value;
        fetch('/admin/users/' + userId + '/roles', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({roleId: roleId})
        }).then(r => { if (r.ok) location.reload(); else alert('Error al asignar role'); });
    }
    function assignTag(userId) {
        const sel = document.getElementById('tagSelect');
        const tagId = sel.value;
        fetch('/admin/users/' + userId + '/tags', {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({tagId: tagId})
        }).then(r => { if (r.ok) location.reload(); else alert('Error al asignar etiqueta'); });
    }
</script>

</body>
</html>