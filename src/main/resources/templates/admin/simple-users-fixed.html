<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Admin PelisApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e1e1e 0%, #2c2c2c 100%);
            min-height: 100vh;
            color: white;
        }
        .table-dark {
            background-color: #2c2c2c;
        }
        .btn-group-vertical .btn {
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-film me-2"></i>PelisApp Admin
            </a>
            <a class="btn btn-outline-light" th:href="@{/admin}">Volver al Panel</a>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="text-white mb-4">Gestión de Usuarios</h1>

        <!-- Error Display -->
        <div th:if="${error}" class="alert alert-danger">
            <span th:text="${error}">Error message</span>
        </div>

        <!-- Stats -->
        <div class="alert alert-info">
            <strong>Total de usuarios:</strong> <span th:text="${totalUsers}">0</span>
        </div>

        <!-- Users Table -->
        <div class="card bg-dark">
            <div class="card-header">
                <h5>Lista de Usuarios - Panel de Moderación</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Nombre</th>
                                <th>Email Confirmado</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="user : ${users}">
                                <td th:text="${user.id}">1</td>
                                <td>
                                    <strong th:text="${user.username}">username</strong>
                                    <div class="small text-muted" th:if="${user.roles != null and !user.roles.isEmpty()}">
                                        <span th:each="role : ${user.roles}"
                                              th:text="${role.name}"
                                              class="badge bg-secondary me-1">ROLE</span>
                                    </div>
                                </td>
                                <td th:text="${user.email}">email@example.com</td>
                                <td th:text="${user.displayName ?: 'Sin nombre'}">Nombre</td>
                                <td>
                                    <span th:if="${user.emailConfirmed}" class="badge bg-success">
                                        <i class="fas fa-check-circle"></i> Confirmado
                                    </span>
                                    <span th:unless="${user.emailConfirmed}" class="badge bg-warning">
                                        <i class="fas fa-exclamation-triangle"></i> Pendiente
                                    </span>
                                </td>
                                <td>
                                    <span th:if="${user.banned}" class="badge bg-danger">
                                        <i class="fas fa-ban"></i> Baneado
                                    </span>
                                    <span th:unless="${user.banned}" class="badge bg-success">
                                        <i class="fas fa-user-check"></i> Activo
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm" role="group">
                                        <!-- Confirmar email -->
                                        <button th:unless="${user.emailConfirmed}"
                                                type="button"
                                                class="btn btn-info btn-sm"
                                                onclick="confirmEmail(this)"
                                                th:data-user-id="${user.id}"
                                                title="Confirmar email manualmente">
                                            <i class="fas fa-envelope-check"></i> Confirmar Email
                                        </button>

                                        <!-- Banear -->
                                        <button th:unless="${user.banned}"
                                                type="button"
                                                class="btn btn-warning btn-sm ban-btn"
                                                onclick="banUser(this)"
                                                th:data-user-id="${user.id}"
                                                title="Banear usuario">
                                            <i class="fas fa-ban"></i> Banear
                                        </button>

                                        <!-- Desbanear -->
                                        <button th:if="${user.banned}"
                                                type="button"
                                                class="btn btn-success btn-sm unban-btn"
                                                onclick="unbanUser(this)"
                                                th:data-user-id="${user.id}"
                                                title="Desbanear usuario">
                                            <i class="fas fa-user-check"></i> Desbanear
                                        </button>

                                        <!-- Eliminar -->
                                        <button type="button"
                                                class="btn btn-danger btn-sm delete-btn"
                                                onclick="deleteUser(this)"
                                                th:data-user-id="${user.id}"
                                                th:data-username="${user.username}"
                                                title="Eliminar usuario">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funciones simplificadas
        function confirmEmail(btn) {
            const userId = btn.getAttribute('data-user-id');
            if (confirm('¿Confirmar email de este usuario?')) {
                performAction('/admin/users/confirm-email/' + userId, 'POST');
            }
        }

        function banUser(btn) {
            const userId = btn.getAttribute('data-user-id');
            if (confirm('¿Banear este usuario?')) {
                performAction('/admin/users/ban/' + userId, 'POST');
            }
        }

        function unbanUser(btn) {
            const userId = btn.getAttribute('data-user-id');
            if (confirm('¿Desbanear este usuario?')) {
                performAction('/admin/users/unban/' + userId, 'POST');
            }
        }

        function deleteUser(btn) {
            const userId = btn.getAttribute('data-user-id');
            const username = btn.getAttribute('data-username');
            if (confirm('¿ELIMINAR PERMANENTEMENTE al usuario "' + username + '"? Esta acción NO se puede deshacer.')) {
                if (confirm('¿Estás COMPLETAMENTE SEGURO?')) {
                    performAction('/admin/users/delete/' + userId, 'POST');
                }
            }
        }

        function performAction(url, method) {
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(data => {
                alert(data);
                window.location.reload();
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        }

        // Ocultar botones para SUPERADMIN al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(function(row) {
                const rolesDiv = row.querySelector('.small.text-muted');
                if (rolesDiv && rolesDiv.textContent.includes('ROLE_SUPERADMIN')) {
                    const deleteBtn = row.querySelector('.delete-btn');
                    const banBtn = row.querySelector('.ban-btn');
                    const unbanBtn = row.querySelector('.unban-btn');

                    if (deleteBtn) deleteBtn.style.display = 'none';
                    if (banBtn) banBtn.style.display = 'none';
                    if (unbanBtn) unbanBtn.style.display = 'none';

                    // Añadir etiqueta de protección
                    const actionsDiv = row.querySelector('.btn-group-vertical');
                    if (actionsDiv) {
                        actionsDiv.innerHTML += '<small class="text-danger mt-2"><i class="fas fa-crown"></i> SUPERADMIN - Protegido</small>';
                    }
                }
            });
        });
    </script>
</body>
</html>
